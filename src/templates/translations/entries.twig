{% extends "pragmatic-web-toolkit/translations/_layout" %}

{% set title = "Entries"|t('pragmatic-web-toolkit') %}
{% set selectedTab = 'entries' %}

{% set crumbs = [
    { label: "Translations"|t('pragmatic-web-toolkit'), url: url('pragmatic-toolkit/translations', { site: selectedSite.handle }) },
    { label: "Entries"|t('pragmatic-web-toolkit'), url: url('pragmatic-toolkit/translations/entries', { site: selectedSite.handle }) },
] %}

{% block sidebar %}
  <nav aria-label="{{ "Sections"|t('pragmatic-web-toolkit') }}">
    <ul class="nav">
      <li>
        <a class="{{ not sectionId ? 'sel' : '' }}" href="{{ url('pragmatic-toolkit/translations/entries', { site: selectedSite.handle, field: fieldFilter }) }}">
          {{ "All entries"|t('pragmatic-web-toolkit') }}
        </a>
      </li>
      {% if sections|length %}
        <li class="heading"><span>{{ "Sections"|t('pragmatic-web-toolkit') }}</span></li>
        {% for section in sections %}
          <li>
            <a class="{{ section.id == sectionId ? 'sel' : '' }}" href="{{ url('pragmatic-toolkit/translations/entries', { site: selectedSite.handle, section: section.id, field: fieldFilter }) }}">
              {{ section.name }} <span class="light" style="margin-left: 2px;">({{ section.count }})</span>
            </a>
          </li>
        {% endfor %}
      {% endif %}
    </ul>
  </nav>
{% endblock %}

{% block content %}
  {% set currentLanguage = selectedSite.language ?? '' %}
  {% set orderedLanguages = [] %}
  {% if currentLanguage and currentLanguage in languages %}
    {% set orderedLanguages = orderedLanguages|merge([currentLanguage]) %}
  {% endif %}
  {% for language in languages %}
    {% if language != currentLanguage %}
      {% set orderedLanguages = orderedLanguages|merge([language]) %}
    {% endif %}
  {% endfor %}

  {% css %}
    tr.entry-group-border > td { border-top: 2px solid #d1d5db; }
    .entries-current-language-col { background: #f3f9ff; }
    .entries-current-language-header { background: #e5f2ff; box-shadow: inset 0 -1px 0 #c8def5; }
    .entries-translate-cell-inner { display: flex; align-items: center; gap: 6px; }
    .entries-translate-action { padding: 0 8px; min-width: 34px; display: inline-flex; align-items: center; justify-content: center; }
  {% endcss %}
  <div class="flex" style="margin-top: 12px; gap: 16px; align-items: flex-end; justify-content: space-between;">
    <form method="get" id="entries-filter" class="flex" style="gap: 12px; align-items: flex-end;">
      <input type="hidden" name="page" value="1">
      <input type="hidden" name="site" value="{{ selectedSite.handle }}">
      <input type="hidden" id="section-input" name="section" value="{{ sectionId }}">
      <div>
        <label for="q">{{ "Search"|t('pragmatic-web-toolkit') }}</label>
        <input class="text" type="text" id="q" name="q" value="{{ search }}" placeholder="{{ "Entry title"|t('pragmatic-web-toolkit') }}">
      </div>
      <div>
        <label for="field">{{ "Field"|t('pragmatic-web-toolkit') }}</label>
        <div class="select">
          <select id="field" name="field">
            {% for option in fieldOptions %}
              <option value="{{ option.value }}" {{ option.value == fieldFilter ? 'selected' : '' }}>{{ option.label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label for="perPage">{{ "Per page"|t('pragmatic-web-toolkit') }}</label>
        <div class="select">
          <select id="perPage" name="perPage">
            {% for option in [50, 100, 250] %}
              <option value="{{ option }}" {{ option == perPage ? 'selected' : '' }}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </form>
    <button class="btn submit" type="submit" form="entries-form" id="save-all-entries">{{ "Save all"|t('pragmatic-web-toolkit') }}</button>
  </div>

  <form method="post" accept-charset="UTF-8" id="entries-form">
    {{ csrfInput() }}
    {{ actionInput('pragmatic-web-toolkit/translations/save-entry-rows') }}
    {{ redirectInput('pragmatic-toolkit/translations/entries', { q: search, perPage: perPage, page: page, section: sectionId, field: fieldFilter, site: selectedSite.handle }) }}

    <table class="data fullwidth" style="margin-top: 16px;">
      <thead>
        <tr>
          <th>{{ "Entry"|t('pragmatic-web-toolkit') }}</th>
          <th>{{ "Field"|t('pragmatic-web-toolkit') }}</th>
          {% for language in orderedLanguages %}
            {% set isCurrentLanguage = language == currentLanguage %}
            <th class="{{ isCurrentLanguage ? 'entries-current-language-col entries-current-language-header' : '' }}">
              {% if isCurrentLanguage %}
                {{ language }}{{ ' (' ~ "Current"|t('pragmatic-web-toolkit') ~ ')' }}
              {% else %}
                <div class="entries-translate-cell-inner">
                  <span>{{ language }}</span>
                  <button class="btn small entries-translate-action js-entries-translate-column" type="button" data-target-language="{{ language }}" title="{{ "Translate column values from selected language"|t('pragmatic-web-toolkit') }}" aria-label="{{ "Translate column values from selected language"|t('pragmatic-web-toolkit') }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2a10 10 0 1 0 7.07 17.07A10 10 0 0 0 12 2zm6.92 9h-3.01a15.7 15.7 0 0 0-1.17-5.04A8.03 8.03 0 0 1 18.92 11zM12 4c.8 1.2 1.72 3.53 1.92 7h-3.84C10.28 7.53 11.2 5.2 12 4zM4.08 13h3.01c.12 1.8.51 3.56 1.17 5.04A8.03 8.03 0 0 1 4.08 13zm3.01-2H4.08a8.03 8.03 0 0 1 4.18-5.04A15.7 15.7 0 0 0 7.09 11zm4.91 9c-.8-1.2-1.72-3.53-1.92-7h3.84c-.2 3.47-1.12 5.8-1.92 7zm2.74-1.96A15.7 15.7 0 0 0 15.91 13h3.01a8.03 8.03 0 0 1-4.18 5.04z" fill="currentColor"></path>
                    </svg>
                  </button>
                </div>
              {% endif %}
            </th>
          {% endfor %}
          <th>{{ "Action"|t('pragmatic-web-toolkit') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          {% set rowIndex = loop.index0 %}
          {% set entryId = row.entry.id %}
          {% set prevEntryId = loop.first ? null : rows[loop.index0 - 1].entry.id %}
          {% set isFirstOfGroup = entryId != prevEntryId %}
          <tr{{ isFirstOfGroup and not loop.first ? ' class="entry-group-border"' : '' }} data-entry-id="{{ entryId }}">
            {% if isFirstOfGroup %}
              <td rowspan="{{ entryRowCounts[entryId] }}" style="vertical-align: top;">
                <a href="#" class="js-entry-slideout" data-entry-id="{{ entryId }}" data-site-id="{{ row.entry.siteId }}">{{ row.entry.title|default('Entry #' ~ entryId) }}</a>
                <div class="light">{{ row.entry.section.name ?? row.entry.type.name ?? "No section or type"|t('pragmatic-web-toolkit') }}</div>
              </td>
            {% endif %}
            <td>
              <input type="hidden" name="entries[{{ rowIndex }}][entryId]" value="{{ entryId }}">
              <input type="hidden" name="entries[{{ rowIndex }}][fieldHandle]" value="{{ row.fieldHandle }}">
              <div>{{ row.fieldLabel }}</div>
              <div class="light">{{ row.fieldHandle }}</div>
            </td>
            {% for language in orderedLanguages %}
              {% set isCurrentLanguage = language == currentLanguage %}
              <td class="{{ isCurrentLanguage ? 'entries-current-language-col' : '' }}">
                <div class="entries-translate-cell-inner">
                  <input class="text fullwidth js-entry-input" name="entries[{{ rowIndex }}][values][{{ language }}]" value="{{ row.values[language] ?? '' }}" data-row-index="{{ rowIndex }}" data-language="{{ language }}">
                  {% if not isCurrentLanguage %}
                    <button class="btn small entries-translate-action js-entries-translate-cell" type="button" data-target-language="{{ language }}" title="{{ "Translate value from selected language"|t('pragmatic-web-toolkit') }}" aria-label="{{ "Translate value from selected language"|t('pragmatic-web-toolkit') }}">
                      <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2a10 10 0 1 0 7.07 17.07A10 10 0 0 0 12 2zm6.92 9h-3.01a15.7 15.7 0 0 0-1.17-5.04A8.03 8.03 0 0 1 18.92 11zM12 4c.8 1.2 1.72 3.53 1.92 7h-3.84C10.28 7.53 11.2 5.2 12 4zM4.08 13h3.01c.12 1.8.51 3.56 1.17 5.04A8.03 8.03 0 0 1 4.08 13zm3.01-2H4.08a8.03 8.03 0 0 1 4.18-5.04A15.7 15.7 0 0 0 7.09 11zm4.91 9c-.8-1.2-1.72-3.53-1.92-7h3.84c-.2 3.47-1.12 5.8-1.92 7zm2.74-1.96A15.7 15.7 0 0 0 15.91 13h3.01a8.03 8.03 0 0 1-4.18 5.04z" fill="currentColor"></path>
                      </svg>
                    </button>
                  {% endif %}
                </div>
              </td>
            {% endfor %}
            <td style="white-space: nowrap;">
              <button class="btn submit js-save-entry-row" type="button" data-row-index="{{ rowIndex }}">{{ "Save"|t('pragmatic-web-toolkit') }}</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>

  <div class="flex justify-between align-center" style="margin-top: 16px;">
    <div>{{ total }} {{ "total"|t('pragmatic-web-toolkit') }}</div>
    <div class="flex" style="gap: 8px; align-items: center;">
      {% set prevPage = page > 1 ? page - 1 : 1 %}
      {% set nextPage = page < totalPages ? page + 1 : totalPages %}
      {% if page == 1 %}
        <span class="btn disabled">{{ "Prev"|t('pragmatic-web-toolkit') }}</span>
      {% else %}
        <a class="btn" href="{{ url('pragmatic-toolkit/translations/entries', { q: search, perPage: perPage, page: prevPage, section: sectionId, field: fieldFilter, site: selectedSite.handle }) }}">{{ "Prev"|t('pragmatic-web-toolkit') }}</a>
      {% endif %}
      <div>{{ "Page"|t('pragmatic-web-toolkit') }} {{ page }} / {{ totalPages }}</div>
      {% if page == totalPages %}
        <span class="btn disabled">{{ "Next"|t('pragmatic-web-toolkit') }}</span>
      {% else %}
        <a class="btn" href="{{ url('pragmatic-toolkit/translations/entries', { q: search, perPage: perPage, page: nextPage, section: sectionId, field: fieldFilter, site: selectedSite.handle }) }}">{{ "Next"|t('pragmatic-web-toolkit') }}</a>
      {% endif %}
    </div>
  </div>

  {% js %}
    (function() {
      const filterForm = document.getElementById('entries-filter');
      const searchInput = document.getElementById('q');
      const fieldSelect = document.getElementById('field');
      const perPageSelect = document.getElementById('perPage');

      if (filterForm) {
        const pageInput = filterForm.querySelector('input[name="page"]');
        function resetPageAndSubmit() {
          if (pageInput) pageInput.value = '1';
          filterForm.submit();
        }

        let searchTimer = null;
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            if (searchTimer) clearTimeout(searchTimer);
            searchTimer = setTimeout(resetPageAndSubmit, 300);
          });
        }
        [fieldSelect, perPageSelect].forEach(function(el) {
          if (el) el.addEventListener('change', resetPageAndSubmit);
        });
      }

      document.querySelectorAll('.js-entry-slideout').forEach(function(link) {
        link.addEventListener('click', function(ev) {
          ev.preventDefault();
          const entryId = parseInt(link.getAttribute('data-entry-id'), 10);
          const siteId = parseInt(link.getAttribute('data-site-id'), 10);
          if (!entryId || !window.Craft) return;
          Craft.createElementEditor('craft\\elements\\Entry', {
            elementId: entryId,
            siteId: siteId || undefined,
            slideout: true
          });
        });
      });

      const entriesForm = document.getElementById('entries-form');
      if (entriesForm && typeof Craft !== 'undefined') {
        entriesForm.addEventListener('click', async function(event) {
          const button = event.target ? event.target.closest('.js-save-entry-row') : null;
          if (!button) return;
          event.preventDefault();

          const rowIndex = button.getAttribute('data-row-index');
          if (rowIndex === null || rowIndex === '') return;

          const originalText = button.textContent;
          button.classList.add('loading');
          button.disabled = true;
          try {
            const formData = new FormData(entriesForm);
            formData.set('saveRow', String(rowIndex));
            const response = await Craft.sendActionRequest('POST', 'pragmatic-web-toolkit/translations/save-entry-row', {
              data: formData,
            });

            if (!response.data || !response.data.success) {
              throw new Error('{{ "Could not save row."|t('pragmatic-web-toolkit')|e('js') }}');
            }

            Craft.cp.displayNotice('{{ "Entry row saved."|t('pragmatic-web-toolkit')|e('js') }}');
          } catch (error) {
            const message = error && error.response && error.response.data && error.response.data.error
              ? error.response.data.error
              : (error && error.message ? error.message : '{{ "Could not save row."|t('pragmatic-web-toolkit')|e('js') }}');
            Craft.cp.displayError(message);
          } finally {
            button.classList.remove('loading');
            button.disabled = false;
            button.textContent = originalText;
          }
        });
      }

      const autotranslateAvailable = {{ autotranslateAvailable|json_encode|raw }};
      const autotranslateDisabledReason = {{ (autotranslateDisabledReason ?? '')|json_encode|raw }};
      const autotranslateTextUrl = {{ autotranslateTextUrl|json_encode|raw }};
      const currentLanguage = {{ currentLanguage|json_encode|raw }};
      function getInputInRow(row, language) {
        return row ? row.querySelector('.js-entry-input[data-language="' + language + '"]') : null;
      }
      async function translateRowsToLanguage(rows, targetLanguage, mode) {
        const tasks = [];
        const texts = [];
        rows.forEach(function(row) {
          const sourceInput = getInputInRow(row, currentLanguage);
          const targetInput = getInputInRow(row, targetLanguage);
          if (!sourceInput || !targetInput) return;
          const sourceValue = String(sourceInput.value || '');
          const targetValue = String(targetInput.value || '');
          if (sourceValue.trim() === '') return;
          if (mode === 'empty' && targetValue.trim() !== '') return;
          tasks.push(targetInput);
          texts.push(sourceValue);
        });

        if (!texts.length) {
          Craft.cp.displayError('{{ "No values available to translate."|t('pragmatic-web-toolkit')|e('js') }}');
          return;
        }

        const response = await Craft.sendActionRequest('POST', autotranslateTextUrl, {
          data: {
            texts: texts,
            sourceLang: currentLanguage,
            targetLang: targetLanguage,
            mimeType: 'text/plain'
          }
        });

        if (!response.data) {
          throw new Error('{{ "Translation failed."|t('pragmatic-web-toolkit')|e('js') }}');
        }
        if (!response.data.success) {
          throw new Error(response.data.error || '{{ "Translation failed."|t('pragmatic-web-toolkit')|e('js') }}');
        }
        if (!Array.isArray(response.data.translations)) {
          throw new Error('{{ "Translation failed."|t('pragmatic-web-toolkit')|e('js') }}');
        }

        response.data.translations.forEach(function(translated, index) {
          if (!tasks[index]) return;
          tasks[index].value = translated || '';
        });
      }
      function openTranslateConfirmModal(options) {
        function countWords(text) {
          return String(text || '').trim().split(/\s+/).filter(Boolean).length;
        }
        function calculateCurrentPageWords(mode) {
          const rows = Array.isArray(options.rows) ? options.rows : [];
          const targetLanguage = options.targetLanguage || '';
          let words = 0;
          rows.forEach(function(row) {
            const sourceInput = getInputInRow(row, currentLanguage);
            const targetInput = getInputInRow(row, targetLanguage);
            if (!sourceInput || !targetInput) return;
            const sourceValue = String(sourceInput.value || '');
            const targetValue = String(targetInput.value || '');
            if (sourceValue.trim() === '') return;
            if (mode === 'empty' && targetValue.trim() !== '') return;
            words += countWords(sourceValue);
          });
          return words;
        }
        const modalEl = document.createElement('div');
        modalEl.className = 'modal fitted';
        modalEl.innerHTML =
          '<div class="body">' +
            '<h2>' + (options.title || '') + '</h2>' +
            '<p class="light">' + (options.description || '') + '</p>' +
            (options.showScopeChoice
              ? '<div class="field" style="margin-top: 12px;">' +
                  '<label>{{ "Scope"|t('pragmatic-web-toolkit')|e('js') }}</label>' +
                  '<label class="checkbox" style="display:block; margin: 6px 0 0;">' +
                    '<input type="radio" name="entries-translate-scope" value="current" checked>' +
                    '<span></span> {{ "Only current page"|t('pragmatic-web-toolkit')|e('js') }}' +
                  '</label>' +
                  '<label class="checkbox" style="display:block; margin: 6px 0 0;">' +
                    '<input type="radio" name="entries-translate-scope" value="all">' +
                    '<span></span> {{ "Include other pages"|t('pragmatic-web-toolkit')|e('js') }}' +
                  '</label>' +
                '</div>'
              : ''
            ) +
            (options.showModeChoice
              ? '<div class="field" style="margin-top: 12px;">' +
                  '<label>{{ "Translation mode"|t('pragmatic-web-toolkit')|e('js') }}</label>' +
                  '<label class="checkbox" style="display:block; margin: 6px 0 0;">' +
                    '<input type="radio" name="entries-translate-mode" value="all">' +
                    '<span></span> {{ "Translate all values"|t('pragmatic-web-toolkit')|e('js') }}' +
                  '</label>' +
                  '<label class="checkbox" style="display:block; margin: 6px 0 0;">' +
                    '<input type="radio" name="entries-translate-mode" value="empty" checked>' +
                    '<span></span> {{ "Translate only empty values"|t('pragmatic-web-toolkit')|e('js') }}' +
                  '</label>' +
                '</div>'
              : ''
            ) +
            '<p class="light" id="entries-translate-word-count" style="margin-top:10px;"></p>' +
            '<div class="buttons right" style="margin-top: 14px;">' +
              '<button type="button" class="btn" id="entries-translate-discard">{{ "Discard"|t('pragmatic-web-toolkit')|e('js') }}</button>' +
              '<button type="button" class="btn submit" id="entries-translate-confirm">{{ "Confirm"|t('pragmatic-web-toolkit')|e('js') }}</button>' +
            '</div>' +
          '</div>';

        const modal = new Garnish.Modal(modalEl, {
          autoShow: true,
          closeOtherModals: true,
          onHide: function() { modal.destroy(); }
        });

        const discardBtn = modalEl.querySelector('#entries-translate-discard');
        const confirmBtn = modalEl.querySelector('#entries-translate-confirm');
        const wordCountEl = modalEl.querySelector('#entries-translate-word-count');
        function updateWordCount() {
          if (!wordCountEl) return;
          const modeInput = modalEl.querySelector('input[name="entries-translate-mode"]:checked');
          const scopeInput = modalEl.querySelector('input[name="entries-translate-scope"]:checked');
          const mode = modeInput ? modeInput.value : 'all';
          const scope = scopeInput ? scopeInput.value : 'current';
          const currentWords = calculateCurrentPageWords(mode);
          if (scope === 'all' && options.totalRowsInScope && options.rows && options.rows.length > 0) {
            const ratio = options.totalRowsInScope / options.rows.length;
            const approxWords = Math.max(currentWords, Math.round(currentWords * ratio));
            wordCountEl.textContent = '{{ "Approx words to translate"|t('pragmatic-web-toolkit')|e('js') }}: ' + approxWords;
            return;
          }
          wordCountEl.textContent = '{{ "Words to translate"|t('pragmatic-web-toolkit')|e('js') }}: ' + currentWords;
        }
        modalEl.querySelectorAll('input[name="entries-translate-mode"], input[name="entries-translate-scope"]').forEach(function(input) {
          input.addEventListener('change', updateWordCount);
        });
        updateWordCount();
        if (discardBtn) {
          discardBtn.addEventListener('click', function() { modal.hide(); });
        }
        if (confirmBtn) {
          confirmBtn.addEventListener('click', function() {
            const modeInput = modalEl.querySelector('input[name="entries-translate-mode"]:checked');
            const mode = modeInput ? modeInput.value : 'all';
            const scopeInput = modalEl.querySelector('input[name="entries-translate-scope"]:checked');
            const scope = scopeInput ? scopeInput.value : 'current';
            confirmBtn.classList.add('loading');
            confirmBtn.disabled = true;
            Promise.resolve(options.onConfirm(mode, scope))
              .then(function() { modal.hide(); })
              .catch(function(error) {
                const message = error && error.response && error.response.data && error.response.data.error
                  ? error.response.data.error
                  : (error && error.message ? error.message : '{{ "Translation failed."|t('pragmatic-web-toolkit')|e('js') }}');
                Craft.cp.displayError(message);
                confirmBtn.classList.remove('loading');
                confirmBtn.disabled = false;
              });
          });
        }
      }

      const entriesTable = document.querySelector('table.data.fullwidth');
      if (entriesTable && typeof Craft !== 'undefined') {
        entriesTable.addEventListener('click', function(event) {
          const cellButton = event.target ? event.target.closest('.js-entries-translate-cell') : null;
          if (cellButton) {
            if (!autotranslateAvailable) {
              Craft.cp.displayError(autotranslateDisabledReason || '{{ "Auto-translation is not available."|t('pragmatic-web-toolkit')|e('js') }}');
              return;
            }
            const row = cellButton.closest('tr');
            const targetLanguage = cellButton.getAttribute('data-target-language') || '';
            if (!row || !targetLanguage) return;
            openTranslateConfirmModal({
              title: '{{ "Translate value from selected language?"|t('pragmatic-web-toolkit')|e('js') }}',
              description: '{{ "This will translate this cell value using the selected language as source."|t('pragmatic-web-toolkit')|e('js') }}',
              showModeChoice: false,
              onConfirm: function() {
                return translateRowsToLanguage([row], targetLanguage, 'all')
                  .then(function() { Craft.cp.displayNotice('{{ "Value translated."|t('pragmatic-web-toolkit')|e('js') }}'); });
              }
            });
            return;
          }

          const columnButton = event.target ? event.target.closest('.js-entries-translate-column') : null;
          if (columnButton) {
            if (!autotranslateAvailable) {
              Craft.cp.displayError(autotranslateDisabledReason || '{{ "Auto-translation is not available."|t('pragmatic-web-toolkit')|e('js') }}');
              return;
            }
            const targetLanguage = columnButton.getAttribute('data-target-language') || '';
            if (!targetLanguage) return;
            const rows = Array.from(entriesTable.querySelectorAll('tbody tr'));
            openTranslateConfirmModal({
              title: '{{ "Translate column values from selected language?"|t('pragmatic-web-toolkit')|e('js') }}',
              description: '{{ "This will translate values in this column using the selected language as source."|t('pragmatic-web-toolkit')|e('js') }}',
              showModeChoice: true,
              showScopeChoice: true,
              rows: rows,
              targetLanguage: targetLanguage,
              totalRowsInScope: {{ total }},
              onConfirm: function(mode, scope) {
                return translateRowsToLanguage(rows, targetLanguage, mode === 'empty' ? 'empty' : 'all')
                  .then(function() {
                    const notice = scope === 'all'
                      ? '{{ "Column translated (based on loaded page values)."|t('pragmatic-web-toolkit')|e('js') }}'
                      : '{{ "Column translated."|t('pragmatic-web-toolkit')|e('js') }}';
                    Craft.cp.displayNotice(notice);
                  });
              }
            });
          }
        });
      }
    })();
  {% endjs %}
{% endblock %}
